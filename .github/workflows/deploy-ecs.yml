# This workflow provides a "one-click" deploy from GitHub Actions.
# Required repository secrets:
#   - ECS_HOST / ECS_USER / ECS_PASSWORD: SSH access (password auth) to the ECS instance.
#   - ECS_DEPLOY_PATH: Absolute path to the asb-platform-infra checkout on ECS.
#   - ACR_REGISTRY / ACR_USERNAME / ACR_PASSWORD: Aliyun Container Registry creds.
name: Deploy ASB Platform to Aliyun ECS

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Git branch to deploy"
        required: false
        default: "main"

permissions:
  contents: read

jobs:
  deploy-to-ecs:
    runs-on: ubuntu-latest
    env:
      ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
      ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
      ECS_DEPLOY_PATH: ${{ secrets.ECS_DEPLOY_PATH }}
      BRANCH: ${{ github.event.inputs.branch || 'main' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          password: ${{ secrets.ECS_PASSWORD }}
          script_stop: true
          envs: ACR_REGISTRY,ACR_USERNAME,ACR_PASSWORD,ECS_DEPLOY_PATH,BRANCH
          script: |
            set -euo pipefail
            DEPLOY_PATH="${ECS_DEPLOY_PATH:-/opt/asb-platform-infra}"
            BRANCH="${BRANCH:-main}"

            echo "[deploy] Using path ${DEPLOY_PATH}"
            cd "${DEPLOY_PATH}"

            echo "[deploy] Updating repository..."
            git fetch --all --prune
            git checkout "${BRANCH}"
            git pull origin "${BRANCH}"

            echo "[deploy] Ensuring deploy script is executable..."
            chmod +x scripts/deploy.sh

            echo "[deploy] Running deployment..."
            ACR_REGISTRY="${ACR_REGISTRY:-}" \
            ACR_USERNAME="${ACR_USERNAME:-}" \
            ACR_PASSWORD="${ACR_PASSWORD:-}" \
            ./scripts/deploy.sh

            echo "[deploy] Deployment completed successfully."

