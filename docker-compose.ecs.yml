# -----------------------------------------------------------------------------
# ASB Platform ECS Compose Stack
# -----------------------------------------------------------------------------
# - Runs the entire ASB Security Platform on a single Ubuntu 24.04 ECS host.
# - Service image references, credentials, and port mappings come from env/ecs.env.
# - Launch command:
#     docker compose --env-file env/ecs.env -f docker-compose.ecs.yml up -d
# -----------------------------------------------------------------------------
version: "3.9"

x-env: &env_defaults
  env_file:
    - env/ecs.env

networks:
  asbnet:
    driver: bridge

volumes:
  pgdata:
  redis-data:
  keycloak-data:
  clickhouse-data:

services:
  postgres:
    <<: *env_defaults
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-asb}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-asbpass}
      POSTGRES_DB: ${POSTGRES_DB:-asb_platform}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-asb} -d ${POSTGRES_DB:-asb_platform}"]
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - asbnet

  redis:
    <<: *env_defaults
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    networks:
      - asbnet

  keycloak:
    <<: *env_defaults
    image: quay.io/keycloak/keycloak:24.0
    restart: unless-stopped
    command: ["start-dev", "--http-relative-path=/"]
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-change_me}
    volumes:
      - keycloak-data:/opt/keycloak/data
    ports:
      - "${KEYCLOAK_PORT:-8081}:8080"
    networks:
      - asbnet

  opa:
    <<: *env_defaults
    image: openpolicyagent/opa:0.63.0
    restart: unless-stopped
    command: ["run", "--server", "--addr=0.0.0.0:8181", "/policies"]
    volumes:
      - ./deploy/opa/policies:/policies:ro
    ports:
      - "8181:8181"
    networks:
      - asbnet

  clickhouse:
    <<: *env_defaults
    image: clickhouse/clickhouse-server:23.8
    restart: unless-stopped
    environment:
      CLICKHOUSE_DB: asb_events
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    ports:
      - "${CLICKHOUSE_HTTP_PORT:-8123}:8123"
    networks:
      - asbnet

  cp-backend:
    <<: *env_defaults
    image: ${ASB_CP_BACKEND_IMAGE}
    restart: unless-stopped
    depends_on:
      - postgres
      - keycloak
      - opa
      - clickhouse
    environment:
      ASB_CP_POSTGRES_HOST: postgres
      ASB_CP_POSTGRES_PORT: 5432
      ASB_CP_POSTGRES_DB: ${ASB_CP_POSTGRES_DB:-asb_platform}
      ASB_CP_POSTGRES_USER: ${POSTGRES_USER:-asb}
      ASB_CP_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-asbpass}
      ASB_CP_KEYCLOAK_BASE_URL: http://keycloak:8080
      ASB_CP_KEYCLOAK_REALM: ${ASB_CP_KEYCLOAK_REALM:-asb}
      ASB_CP_KEYCLOAK_CLIENT_ID: ${ASB_CP_KEYCLOAK_CLIENT_ID:-cp-frontend}
      ASB_CP_KEYCLOAK_CLIENT_SECRET: ${ASB_CP_KEYCLOAK_CLIENT_SECRET:-changeme}
      ASB_CP_OPA_BASE_URL: http://opa:8181
      ASB_CP_OPA_POLICY_PATH: ${ASB_CP_OPA_POLICY_PATH:-/v1/data/asb/policies}
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_DB: asb_events
      PORT: 8080
    ports:
      - "${CP_BACKEND_PORT:-8080}:8080"
    networks:
      - asbnet

  cp-frontend:
    <<: *env_defaults
    image: ${ASB_CP_FRONTEND_IMAGE}
    restart: unless-stopped
    depends_on:
      - cp-backend
    environment:
      VITE_API_BASE_URL: http://cp-backend:8080
      VITE_KEYCLOAK_URL: http://keycloak:${KEYCLOAK_PORT:-8081}
    ports:
      - "${CP_FRONTEND_PORT:-80}:80"
    networks:
      - asbnet

  gateway:
    <<: *env_defaults
    image: ${ASB_GATEWAY_IMAGE}
    restart: unless-stopped
    depends_on:
      - cp-backend
      - auth-service
      - policy-service
      - privacy-service
      - prompt-defense
      - output-guard
      - agent-control
      - audit-service
    environment:
      CONTROL_PLANE_BASE_URL: http://cp-backend:8080
      AUTH_SERVICE_URL: http://auth-service:8001
      POLICY_SERVICE_URL: http://policy-service:8002
      PRIVACY_SERVICE_URL: http://privacy-service:8003
      PROMPT_DEFENSE_URL: http://prompt-defense:8004
      OUTPUT_GUARD_URL: http://output-guard:8005
      AGENT_CONTROL_URL: http://agent-control:8006
      AUDIT_SERVICE_URL: http://audit-service:8007
      PORT: 8000
    ports:
      - "${GATEWAY_PORT:-8000}:8000"
    networks:
      - asbnet

  auth-service:
    <<: *env_defaults
    image: ${ASB_AUTH_IMAGE}
    restart: unless-stopped
    depends_on:
      - postgres
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${POSTGRES_DB:-asb_platform}
      DB_USER: ${POSTGRES_USER:-asb}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-asbpass}
      PORT: 8001
    networks:
      - asbnet

  policy-service:
    <<: *env_defaults
    image: ${ASB_POLICY_IMAGE}
    restart: unless-stopped
    depends_on:
      - opa
    environment:
      OPA_BASE_URL: http://opa:8181
      PORT: 8002
    networks:
      - asbnet

  privacy-service:
    <<: *env_defaults
    image: ${ASB_PRIVACY_IMAGE}
    restart: unless-stopped
    environment:
      PORT: 8003
    networks:
      - asbnet

  prompt-defense:
    <<: *env_defaults
    image: ${ASB_PROMPT_DEFENSE_IMAGE}
    restart: unless-stopped
    environment:
      PORT: 8004
    networks:
      - asbnet

  output-guard:
    <<: *env_defaults
    image: ${ASB_OUTPUT_GUARD_IMAGE}
    restart: unless-stopped
    environment:
      PORT: 8005
    networks:
      - asbnet

  agent-control:
    <<: *env_defaults
    image: ${ASB_AGENT_CONTROL_IMAGE}
    restart: unless-stopped
    environment:
      PORT: 8006
    networks:
      - asbnet

  audit-service:
    <<: *env_defaults
    image: ${ASB_AUDIT_IMAGE}
    restart: unless-stopped
    depends_on:
      - clickhouse
    environment:
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_DB: asb_events
      PORT: 8007
    networks:
      - asbnet

  example-service:
    <<: *env_defaults
    image: ${ASB_EXAMPLE_SERVICE_IMAGE}
    restart: unless-stopped
    environment:
      PORT: 8010
    networks:
      - asbnet

