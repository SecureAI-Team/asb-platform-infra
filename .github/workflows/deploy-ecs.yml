# This workflow provides a "one-click" deploy from GitHub Actions.
# Required repository secrets:
#   - ECS_HOST / ECS_USER / ECS_PASSWORD: SSH access (password auth) to the ECS instance.
#   - ACR_REGISTRY / ACR_USERNAME / ACR_PASSWORD: Aliyun Container Registry creds.
name: Deploy ASB Platform to Aliyun ECS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      branch:
        description: "Git branch to deploy"
        required: false
        default: "main"

permissions:
  contents: read

jobs:
  deploy-to-ecs:
    runs-on: ubuntu-latest
    environment: secrets
    env:
      ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
      ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
      BRANCH: ${{ github.event.inputs.branch || 'main' }}
      REPO_URL: https://github.com/${{ github.repository }}.git
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          password: ${{ secrets.ECS_PASSWORD }}
          script_stop: true
          envs: ACR_REGISTRY,ACR_USERNAME,ACR_PASSWORD,BRANCH,REPO_URL
          script: |
            set -euo pipefail
            DEPLOY_PATH="/opt/asb-platform-infra"
            BRANCH="${BRANCH:-main}"
            REPO_URL="${REPO_URL:-https://github.com/${{ github.repository }}.git}"

            echo "[deploy] Ensuring repository exists at ${DEPLOY_PATH}"
            if [[ ! -d "${DEPLOY_PATH}/.git" ]]; then
              echo "[deploy] Repository missing; cloning ${REPO_URL}..."
              mkdir -p "$(dirname "${DEPLOY_PATH}")"
              git clone "${REPO_URL}" "${DEPLOY_PATH}"
            fi

            echo "[deploy] Using path ${DEPLOY_PATH}"
            cd "${DEPLOY_PATH}"

            echo "[deploy] Updating repository..."
            git fetch --all --prune
            git checkout "${BRANCH}"
            git pull origin "${BRANCH}"

            echo "[deploy] Ensuring deploy script is executable..."
            chmod +x scripts/deploy.sh

            echo "[deploy] Running deployment..."
            ACR_REGISTRY="${ACR_REGISTRY:-}" \
            ACR_USERNAME="${ACR_USERNAME:-}" \
            ACR_PASSWORD="${ACR_PASSWORD:-}" \
            ./scripts/deploy.sh

            echo "[deploy] Deployment completed successfully."

