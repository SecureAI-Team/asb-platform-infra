# This workflow provides a "one-click" deploy from GitHub Actions.
# Required repository secrets:
#   - ECS_HOST / ECS_USER / ECS_PASSWORD: SSH access (password auth) to the ECS instance.
#   - ACR_REGISTRY / ACR_USERNAME / ACR_PASSWORD: Aliyun Container Registry creds.
#   - ECS_ENV_FILE_B64: Base64-encoded env/ecs.env content to place on the ECS host.
name: Deploy ASB Platform to Aliyun ECS

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  deploy-to-ecs:
    runs-on: ubuntu-latest
    environment: secrets
    env:
      ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
      ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
      ECS_ENV_FILE_B64: ${{ secrets.ECS_ENV_FILE_B64 }}
      BRANCH: main
      REPO_URL: https://github.com/${{ github.repository }}.git
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          password: ${{ secrets.ECS_PASSWORD }}
          script_stop: true
          envs: ACR_REGISTRY,ACR_USERNAME,ACR_PASSWORD,ECS_ENV_FILE_B64,BRANCH,REPO_URL
          script: |
            set -euo pipefail
            DEPLOY_PATH="/opt/asb-platform-infra"
            BRANCH="${BRANCH:-main}"
            REPO_URL="${REPO_URL:-https://github.com/${{ github.repository }}.git}"
            MAX_RETRIES=3
            RETRY_SLEEP=5

            echo "[deploy] Ensuring repository exists at ${DEPLOY_PATH}"
            if [[ ! -d "${DEPLOY_PATH}/.git" ]]; then
              echo "[deploy] Repository missing; cloning ${REPO_URL}..."
              mkdir -p "$(dirname "${DEPLOY_PATH}")"
              attempt=1
              until git clone "${REPO_URL}" "${DEPLOY_PATH}"; do
                if [[ ${attempt} -ge ${MAX_RETRIES} ]]; then
                  echo "[deploy] Failed to clone repository after ${MAX_RETRIES} attempts."
                  exit 1
                fi
                attempt=$((attempt + 1))
                echo "[deploy] Clone failed. Retrying in ${RETRY_SLEEP}s (attempt ${attempt}/${MAX_RETRIES})..."
                sleep "${RETRY_SLEEP}"
              done
            fi

            echo "[deploy] Using path ${DEPLOY_PATH}"
            cd "${DEPLOY_PATH}"

            echo "[deploy] Updating repository..."
            attempt=1
            until git fetch --all --prune; do
              if [[ ${attempt} -ge ${MAX_RETRIES} ]]; then
                echo "[deploy] git fetch failed after ${MAX_RETRIES} attempts."
                exit 1
              fi
              attempt=$((attempt + 1))
              echo "[deploy] git fetch failed. Retrying in ${RETRY_SLEEP}s (attempt ${attempt}/${MAX_RETRIES})..."
              sleep "${RETRY_SLEEP}"
            done
            git checkout "${BRANCH}"
            attempt=1
            until git pull origin "${BRANCH}"; do
              if [[ ${attempt} -ge ${MAX_RETRIES} ]]; then
                echo "[deploy] git pull failed after ${MAX_RETRIES} attempts."
                exit 1
              fi
              attempt=$((attempt + 1))
              echo "[deploy] git pull failed. Retrying in ${RETRY_SLEEP}s (attempt ${attempt}/${MAX_RETRIES})..."
              sleep "${RETRY_SLEEP}"
            done

            echo "[deploy] Ensuring deploy script is executable..."
            chmod +x scripts/deploy.sh

            if [[ -n "${ECS_ENV_FILE_B64:-}" ]]; then
              echo "[deploy] Writing env/ecs.env from secret..."
              mkdir -p env
              echo "${ECS_ENV_FILE_B64}" | base64 -d > env/ecs.env
            else
              echo "[deploy] Warning: ECS_ENV_FILE_B64 not set; assuming env/ecs.env already exists."
            fi

            echo "[deploy] Running deployment..."
            ACR_REGISTRY="${ACR_REGISTRY:-}" \
            ACR_USERNAME="${ACR_USERNAME:-}" \
            ACR_PASSWORD="${ACR_PASSWORD:-}" \
            ./scripts/deploy.sh

            echo "[deploy] Deployment completed successfully."

