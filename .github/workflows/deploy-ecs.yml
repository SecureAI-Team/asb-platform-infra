# This workflow provides a "one-click" deploy from GitHub Actions.
# Required repository secrets:
#   - ECS_HOST / ECS_USER / ECS_PASSWORD: SSH access (password auth) to the ECS instance.
#   - ACR_REGISTRY / ACR_USERNAME / ACR_PASSWORD: Aliyun Container Registry creds.
#   - ECS_ENV_FILE_B64 (optional): Base64-encoded env/ecs.env content. When absent, the workflow generates one from env/ecs.env.example.
name: Deploy ASB Platform to Aliyun ECS

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  deploy-to-ecs:
    runs-on: ubuntu-latest
    environment: secrets
    env:
      ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
      ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
      ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
      ECS_ENV_FILE_B64: ${{ secrets.ECS_ENV_FILE_B64 }}
      BRANCH: main
      REPO_URL: https://github.com/${{ github.repository }}.git
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          password: ${{ secrets.ECS_PASSWORD }}
          script_stop: true
          envs: ACR_REGISTRY,ACR_USERNAME,ACR_PASSWORD,ECS_ENV_FILE_B64,BRANCH,REPO_URL
          script: |
            cat <<'BASH' >/tmp/asb-deploy.sh
            #!/usr/bin/env bash
            set -euo pipefail

            DEPLOY_PATH="/opt/asb-platform-infra"
            BRANCH="${BRANCH:-main}"
            REPO_URL="${REPO_URL:-https://github.com/SecureAI-Team/asb-platform-infra.git}"
            MAX_RETRIES=3
            RETRY_SLEEP=5

            retry_cmd() {
              local desc="$1"
              shift
              local attempt=1
              while true; do
                if "$@"; then
                  break
                fi
                if [[ ${attempt} -ge ${MAX_RETRIES} ]]; then
                  echo "[deploy] ${desc} failed after ${MAX_RETRIES} attempts."
                  exit 1
                fi
                attempt=$((attempt + 1))
                echo "[deploy] ${desc} failed. Retrying in ${RETRY_SLEEP}s (attempt ${attempt}/${MAX_RETRIES})..."
                sleep "${RETRY_SLEEP}"
              done
            }

            echo "[deploy] Validating ECS runtime requirements..."
            for cmd in git docker base64; do
              if ! command -v "${cmd}" >/dev/null 2>&1; then
                echo "[deploy] Missing required command '${cmd}'."
                exit 1
              fi
            done
            if ! docker info >/dev/null 2>&1; then
              echo "[deploy] Docker daemon is not running or unreachable."
              exit 1
            fi
            if ! docker compose version >/dev/null 2>&1; then
              echo "[deploy] Docker Compose plugin is not available."
              exit 1
            fi
            echo "[deploy] ECS prerequisites OK."

            echo "[deploy] Ensuring repository exists at ${DEPLOY_PATH}"
            if [[ -d "${DEPLOY_PATH}" ]]; then
            echo "[deploy] Removing existing contents at ${DEPLOY_PATH}..."
              rm -rf "${DEPLOY_PATH}"
            fi
            mkdir -p "$(dirname "${DEPLOY_PATH}")"
            clone_logs="${DEPLOY_PATH}.clone.log"
            rm -f "${clone_logs}"
            clone_success=false
            for attempt in $(seq 1 ${MAX_RETRIES}); do
              echo "[deploy] Cloning repository (attempt ${attempt}/${MAX_RETRIES})..."
              if git clone "${REPO_URL}" "${DEPLOY_PATH}" 2>&1 | tee -a "${clone_logs}"; then
                clone_success=true
                break
              fi
              if [[ ${attempt} -lt ${MAX_RETRIES} ]]; then
                echo "[deploy] git clone failed, but will retry in ${RETRY_SLEEP}s..."
                sleep "${RETRY_SLEEP}"
              fi
            done

            if [[ "${clone_success}" != "true" ]]; then
              if [[ -d "${DEPLOY_PATH}/.git" ]]; then
                echo "[deploy] Clone reported failures, but repository directory exists; proceeding anyway."
              else
                echo "[deploy] Failed to clone repository after ${MAX_RETRIES} attempts. Recent output:"
                tail -n 50 "${clone_logs}"
                exit 1
              fi
            fi

            echo "[deploy] Using path ${DEPLOY_PATH}"
            cd "${DEPLOY_PATH}"

            echo "[deploy] Ensuring deploy script is executable..."
            chmod +x scripts/deploy.sh

            mkdir -p env
            echo "[deploy] Contents of env template directory:"
            ls -al env || true
            if [[ -n "${ECS_ENV_FILE_B64:-}" ]]; then
              echo "[deploy] Writing env/ecs.env from secret..."
              echo "${ECS_ENV_FILE_B64}" | base64 -d > env/ecs.env
            else
              echo "[deploy] Generating env/ecs.env from template..."
              echo "[deploy] Copying env/ecs.env.example -> env/ecs.env"
              cp env/ecs.env.example env/ecs.env
              echo "[deploy] Populating env/ecs.env with secrets..."

              random_pw() {
                tr -dc 'A-Za-z0-9' </dev/urandom | head -c "${1:-24}"
              }

              sed -i \
                -e "s|^ACR_REGISTRY=.*|ACR_REGISTRY=${ACR_REGISTRY}|" \
                -e "s|^ACR_USERNAME=.*|ACR_USERNAME=${ACR_USERNAME}|" \
                -e "s|^ACR_PASSWORD=.*|ACR_PASSWORD=${ACR_PASSWORD}|" \
                -e "s|^POSTGRES_PASSWORD=.*|POSTGRES_PASSWORD=$(random_pw)|" \
                -e "s|^KEYCLOAK_ADMIN_PASSWORD=.*|KEYCLOAK_ADMIN_PASSWORD=$(random_pw)|" \
                env/ecs.env

              ACR_NAMESPACE_VALUE=$(grep '^ACR_NAMESPACE=' env/ecs.env | cut -d'=' -f2-)
              ACR_NAMESPACE_VALUE=${ACR_NAMESPACE_VALUE:-asbsecurity}

              update_image() {
                local key="$1"
                local image="$2"
                sed -i "s|^${key}=.*|${key}=${ACR_REGISTRY}/${ACR_NAMESPACE_VALUE}/${image}|" env/ecs.env
              }

              update_image "ASB_CP_BACKEND_IMAGE" "cp-backend:latest"
              update_image "ASB_CP_FRONTEND_IMAGE" "cp-frontend:latest"
              update_image "ASB_GATEWAY_IMAGE" "asb-secure-gateway:latest"
              update_image "ASB_AUTH_IMAGE" "auth:latest"
              update_image "ASB_POLICY_IMAGE" "policy:latest"
              update_image "ASB_PRIVACY_IMAGE" "privacy:latest"
              update_image "ASB_PROMPT_DEFENSE_IMAGE" "prompt-defense:latest"
              update_image "ASB_OUTPUT_GUARD_IMAGE" "output-guard:latest"
              update_image "ASB_AGENT_CONTROL_IMAGE" "agent-control:latest"
              update_image "ASB_AUDIT_IMAGE" "audit:latest"
              update_image "ASB_EXAMPLE_SERVICE_IMAGE" "example-service:latest"
            fi

            chmod 600 env/ecs.env

            echo "[deploy] Running deployment..."
            ACR_REGISTRY="${ACR_REGISTRY:-}" \
            ACR_USERNAME="${ACR_USERNAME:-}" \
            ACR_PASSWORD="${ACR_PASSWORD:-}" \
            ./scripts/deploy.sh

            echo "[deploy] Deployment completed successfully."
            BASH
            bash /tmp/asb-deploy.sh

